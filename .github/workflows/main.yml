name: Setup KDE Plasma Runner + Tailscale + VNC + Web VNC

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  setup-gui-runner:
    runs-on: ubuntu-latest

    env:
      USERNAME: runner
      PASSWORD: runner
      TAILSCALE_HOSTNAME: gh-kde-vnc-${{ github.run_id }}

    steps:
      - uses: actions/checkout@v4

      - name: Ensure runner user has sudo
        shell: bash
        run: |
          echo "${USERNAME}:${PASSWORD}" | sudo chpasswd
          echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" | sudo tee /etc/sudoers.d/${USERNAME} >/dev/null
          sudo chmod 0440 /etc/sudoers.d/${USERNAME}

      - name: Install KDE Plasma + VNC server
        shell: bash
        run: |
          sudo apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            kde-plasma-desktop konsole dbus-x11 xorg \
            tigervnc-standalone-server tigervnc-common tigervnc-tools

          sudo -u "${USERNAME}" mkdir -p "/home/${USERNAME}/.vnc"
          echo "${PASSWORD}" | sudo -u "${USERNAME}" vncpasswd -f > "/home/${USERNAME}/.vnc/passwd"
          sudo chmod 600 "/home/${USERNAME}/.vnc/passwd"
          sudo chown -R "${USERNAME}:${USERNAME}" "/home/${USERNAME}/.vnc"

          # TigerVNC startup for Plasma (reliable)
          sudo tee "/home/${USERNAME}/.vnc/xstartup" >/dev/null <<'EOF'
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          export XDG_SESSION_TYPE=x11
          export KDE_FULL_SESSION=true
          export XDG_CURRENT_DESKTOP=KDE
          exec dbus-launch --exit-with-session startplasma-x11
          EOF
          sudo chmod +x "/home/${USERNAME}/.vnc/xstartup"
          sudo chown "${USERNAME}:${USERNAME}" "/home/${USERNAME}/.vnc/xstartup"

      - name: Install noVNC (Web VNC)
        shell: bash
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq novnc websockify
          sudo ln -sf /usr/share/novnc/vnc.html /usr/share/novnc/index.html

      - name: Install Tailscale (interactive login)
        shell: bash
        run: |
          curl -fsSL https://tailscale.com/install.sh | sudo sh
          echo "Run tailscale up - login link will appear below"
          sudo tailscale up --hostname "${TAILSCALE_HOSTNAME}"
          echo "Tailscale IPv4:"
          sudo tailscale ip -4 || true

      - name: Start VNC + Web VNC + Show connection info
        shell: bash
        run: |
          # Kill old server if any
          sudo -u "${USERNAME}" vncserver -kill :1 >/dev/null 2>&1 || true

          echo "Starting VNC server on :1 (5901)..."
          sudo -u "${USERNAME}" vncserver :1 \
            -geometry 1280x800 \
            -depth 24 \
            -localhost no

          TAILSCALE_IP="$(sudo tailscale ip -4 | head -n1 || true)"

          echo "Starting noVNC on 6080 (web -> 5901)..."
          sudo nohup websockify --web=/usr/share/novnc/ 6080 localhost:5901 >/tmp/novnc.log 2>&1 &

          echo "=== CONNECTION INFO ==="
          echo "VNC USER: ${USERNAME}"
          echo "VNC PASS: ${PASSWORD}"
          echo "Native VNC: ${TAILSCALE_IP}:5901"
          echo "Web VNC:    http://${TAILSCALE_IP}:6080"
          echo
          echo "Keeping runner alive..."
          while true; do sleep 600; done
